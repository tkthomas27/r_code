---
title: "Buyback Charts"
output:
  html_notebook: null
  html_document: default
  pdf_document: default
  toc: yes
pdf_document: default
number_sections: yes
---

```{r init,tidy=TRUE, messages=FALSE}
library(plotly) #for interactive graphs
library(ggplot2) #for better graphs
library(dplyr)
library(tidyr) #for cleaning datasets
library(psych) #for describe function
library(reshape2) #for reshaping data
library(zoo) #for date functions
library(scales) #for breaks in plots
library(knitr) #for kable
library(ggthemes) #for better themes
library(data.table)
library(DT)

s5 <- read.csv("/Volumes/jet/dropbox/asr/datasets/sp500.csv") # read in data

# keep relevant variables
s5<-s5[,c('year','tic','repo','exf_exist_end','ni','totdiv_adj','gsector','dec_mcap')]

# label gsector
s5$gsector <- ordered(s5$gsector,
    levels = c(seq(10,60,5)),
    labels = c("Energy", "Materials", "Industrials", "Consumer Disc.", "Consumer Staples", "Health Care", "Financials", "Info. Tech.", "Telecomm.", "Utilities", "Real Estate"))

# scale repurchases from compustat and create new variables
s5 <- within(s5,{
    repo = repo/1000
    ni = ni/1000
    exf_exist_end = -1*(exf_exist_end/1000000)
    totdiv_adj = totdiv_adj/1000000
    count = 1
    payout = repo + totdiv_adj
    netpayout = totdiv_adj + exf_exist_end
    ei = -1*(repo - exf_exist_end)
    dec_mcap = dec_mcap/1000000
})

# rename columns
colnames(s5) <- c("Year", "Firm", "Repurchases", "Net.Repurchases", "Net.Income", "Dividends","Sector","MCap","Equity.Iss", "Net.Payouts", "Payouts", "Count")

s5_2015 <- subset(s5,Year==2015 & Year<2016) # create 2015 data
s5_3y <- subset(s5,Year>2012 & Year<2016) # create 3 year data
s5_10y <- subset(s5,Year>2005 & Year<2016) # create 10 year data

```

# By Year

```{r aggregate_year}
s5_annt <- aggregate(.~Year, s5_10y, sum) #aggregate by year
s5_anns <- aggregate(.~Year + Sector, s5_10y, sum) #aggregate by year and sector

s5_annt<-subset(s5_annt, select=-c(Firm,Sector)) #remove summed firm/sector
s5_anns<-subset(s5_anns, select=-c(Firm)) #remove summed firm/sector

round(s5_annt,2) # look at annual data
s5_anns[,3:9]<-round(s5_anns[,3:9],2) #round then...
s5_anns #look at annual-sector data
# describeBy(s5_anns[,c("Repurchases","Equity.Iss")],s5_anns$Sector, fast=T, mat=T, digits=2)
```

The following two boxplots chart the data presented in the above table. Each sector-box shows the distribution of the 10 observations for each variable.

```{r plot_agg_year}
p_rep <- ggplot(s5_anns, aes(x=Sector, y=Repurchases, fill = Sector)) + geom_boxplot() +
    labs(list(title = "Distribution of Repurchases by Sector and Year (2006-2015)", y = "Billions", x = "")) +
    theme_minimal() + theme(axis.text.x=element_blank())

ggplotly(p_rep)

p_ei <- ggplot(s5_anns, aes(x=Sector, y=Equity.Iss, fill = Sector)) + geom_boxplot() +
    labs(list(title = "Distribution of Equity Issuances by Sector and Year (2006-2015)", y = "Billions", x = "")) +
    theme_minimal() + theme(axis.text.x=element_blank())

ggplotly(p_ei)


```


```{r total_annual, warning=FALSE, error=FALSE, message=FALSE}

s5_annt$MCap <- s5_annt$MCap/1000  

plot_ly(s5_annt) %>%
  add_trace(x = ~Year, y = ~MCap, fill='tozeroy', name = 'Market Cap',
            marker = list(color = '#7E827A')) %>%
  add_trace(x = ~Year, y = ~Repurchases, type = 'scatter', mode = 'lines', name = 'Repurchases', yaxis = 'y2',
            line = list(color = '#11BA7D', width=5)) %>%
  add_trace(x = ~Year, y = ~Dividends, type = 'scatter', mode = 'lines', name = 'Dividends', yaxis = 'y2',
            line = list(color = '#3498DB', width=5, dash='dash')) %>%
  layout(title = 'S&P 500 Repurchases and Dividends (2006-2015)',
         xaxis = list(title = "", dtick=1, showgrid=FALSE),
         yaxis = list(side = 'right', title = 'Trillions', showgrid = FALSE, zeroline = FALSE),
         yaxis2 = list(side = 'left', overlaying = "y", title = 'Billions', showgrid = FALSE, tick0=0))

plot_ly(s5_annt) %>%
  add_trace(x = ~Year, y = ~Net.Income, fill='tozeroy', name = 'Net.Income',
            marker = list(color = '#7E827A')) %>%
  add_trace(x = ~Year, y = ~Payouts, type = 'scatter', mode = 'lines', name = 'Payouts',
            line = list(color = '#11BA7D', width=5)) %>%
  add_trace(x = ~Year, y = ~Net.Payouts, type = 'scatter', mode = 'lines', name = 'Net Payouts', 
            line = list(color = '#3498DB', width=5, dash='dash')) %>%
  layout(title = 'S&P 500 Shareholder Payouts (2006-2015)',
         xaxis = list(title = "", dtick=1, showgrid = FALSE),
         yaxis = list(side = 'left', title = 'Billions', showgrid = FALSE, zeroline = FALSE))

```

# By Firm

```{r aggregate_firm, warning=TRUE}

# sum 10 year data
s5_10y <- aggregate(.~Firm + Sector, s5_10y, sum)
# drop if not full 10 years of data
s5_10y <- subset(s5_10y,Count==10)

# kable(describe(s5_10y_ann[2:6], fast = T),digits = 2)

# sum 3 year data
s5_3y <- aggregate(.~Firm + Sector, s5_3y, sum)
# drop if not full 10 years of data
s5_3y <- subset(s5_3y,Count==3)

```


```{r firms_repo}

pldf <- subset(s5_10y,Net.Income>0)

pldf$Firm <- as.character(pldf$Firm) # is this necessary
pldf$Firm <- droplevels(as.factor(pldf$Firm))

# rank payout/ni and sort by rank
pldf$Rank = rank(-pldf$Repurchases, ties.method="first")
pldf <- pldf[order(pldf$Rank),] 
pl_repo10 <- ggplot(pldf, aes(x=Rank, y=Repurchases, fill = Sector,text = paste("Firm:", Firm))) + 
        geom_bar(stat="identity") +
        labs(list(title = "Repurchase Rank (2006-2015)", y = "Billions", x = "")) + 
        theme_minimal() + theme(legend.title=element_blank())

ggplotly(pl_repo10)

# rank payout/ni and sort by rank
pldf <- subset(s5_3y,Net.Income>0)
pldf$Firm <- as.character(pldf$Firm) # is this necessary
pldf$Firm <- droplevels(as.factor(pldf$Firm))
pldf$Rank = rank(-pldf$Repurchases, ties.method="first")
pldf <- pldf[order(pldf$Rank),] 
pl_repo3 <- ggplot(pldf, aes(x=Rank, y=Repurchases, fill = Sector,text = paste("Firm:", Firm))) + 
        geom_bar(stat="identity") +
        labs(list(title = "Repurchase Rank (2013-2015)", y = "Billions", x = "")) + 
        theme_minimal() + theme(legend.title=element_blank())

ggplotly(pl_repo3)

# rank payout/ni and sort by rank
pldf <- subset(s5_2015,Net.Income>0)
pldf$Firm <- as.character(pldf$Firm) # is this necessary
pldf$Firm <- droplevels(as.factor(pldf$Firm))
pldf$Rank = rank(-pldf$Repurchases, ties.method="first")
pldf <- pldf[order(pldf$Rank),] 
pl_repo1 <- ggplot(pldf, aes(x=Rank, y=Repurchases, fill = Sector, text = paste("Firm:", Firm))) + 
        geom_bar(stat="identity") + 
        labs(list(title = "Repurchase Rank (2015)", y = "Billions", x = "")) + 
        #geom_hline(yintercept = mean(pldf$Repurchases), color="black", labels="xx") +
        theme_minimal() + theme(legend.title=element_blank())

ggplotly(pl_repo1)

pldf <- subset(s5_2015,Net.Income>0)
pldf$Firm <- as.character(pldf$Firm) # is this necessary
pldf$Firm <- droplevels(as.factor(pldf$Firm))
pldf$Rank = rank(-pldf$Repurchases, ties.method="first")
pldf <- pldf[order(pldf$Rank),]
pldf$Repurchases <- log(pldf$Repurchases)
pldf$Rank <- log(pldf$Rank)
pl_repo1 <- ggplot(pldf, aes(x=Rank, y=Repurchases, fill = Sector, text = paste("Firm:", Firm))) + 
        geom_point() + 
        labs(list(title = "Repurchase Rank (2015)", y = "Billions", x = "")) + 
        #geom_hline(yintercept = mean(pldf$Repurchases), color="black", labels="xx") +
        theme_minimal() + theme(legend.title=element_blank())

ggplotly(pl_repo1)


```


```{r firms_reponet}

disp_10y <- s5_10y %>% mutate_each(funs(round(.,2)), Repurchases, Net.Repurchases,Net.Income,Dividends,MCap,Equity.Iss,Net.Payouts,Payouts)
DT::datatable(disp_10y)

pldf <- s5_10y

pldf$Firm <- as.character(pldf$Firm) # is this necessary
pldf$Firm <- droplevels(as.factor(pldf$Firm))

# rank payout/ni and sort by rank
pldf$Rank = rank(-pldf$Repurchases, ties.method="first")
pldf <- pldf[order(pldf$Rank),] 

plot_ly(pldf, x = ~Rank, y = ~Repurchases, type = 'bar', name = 'Repurchases',text = ~Firm) %>%
    add_trace(y = ~Net.Repurchases, name = 'Net Repurchases') %>%
    layout(title = "Repurchases and Net Repurchases (2006-2015)",yaxis = list(title = 'Billions', showgrid = FALSE), barmode = 'overlay')
```


```{r payouts_rank}

pldf <- subset(s5_10y,Net.Income>0)

# create payout/ni
pldf$Payouts.NI = pldf$Payouts/pldf$Net.Income

# create net payout
pldf$Net.Payouts.NI = pldf$Net.Payouts/pldf$Net.Income

# rank payout/ni and sort by rank
pldf$Payouts.NI.Rank = rank(pldf$Payouts.NI)
pldf$Net.Payouts.NI.Rank = rank(pldf$Net.Payouts.NI)
pldf <- pldf[order(pldf$Payouts.NI.Rank),] 

plot_ly(pldf) %>%
  add_trace(x = ~Payouts.NI.Rank, y = ~round(Payouts.NI,2), type = 'scatter', mode = 'lines', name = 'Payouts', 
            text = ~paste('Firm: ', Firm, '</br> Payouts: ', round(Payouts,2),'</br> Net Income: ', round(Net.Income,2)),
            line = list(color = '#11BA7D', width=2)) %>%
  add_trace(x = ~Payouts.NI.Rank, y = ~round(Net.Payouts.NI,2), type = 'scatter', mode = 'lines', name = 'Net Payouts',
            text = ~paste('Net Payouts: ', round(Net.Payouts,2)),
            line = list(color = '#3498DB', width=2)) %>%
  layout(title = 'S&P 500 Shareholder Payouts (2006-2015)',
         xaxis = list(title = "", dtick=50, showgrid = FALSE),
         yaxis = list(side = 'left', title = 'Billions', showgrid = FALSE, zeroline = FALSE))

```
