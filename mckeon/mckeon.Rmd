---
title: 'McKeon 2015 - Measuring Equity Issuances'
output:
  html_notebook:
    toc: true
    number_sections: true
  pdf_document: default
---

# Paper Notes

1. Introduction
	+ Equity issuance is important topic
	+ But most equity issuance is attributable to ESO and not managers; these two sources have different effects
	+ Goals:
		+ Decompose Compustat data into employee-initiated and manager-initiated
		+ Show how employee-initiated issues confound tests of manager decisions
	+ Decomposition from size filter: if issuance is more than 3\% of mkval, then it is firm initiated
	+ Tests of manager decisions:
		+ McLean (2011) vs Deangelo et al (2010)
			+ Problem: are firms issuing as a precaution or because of a liquidity squeeze?
			+ Solution: Precautionary issuance are not really precautionary --- due to option exercise
		+ Baker and Wurgler (2002): important paper on motivation of equity issuance
			+ Problem: managers issue when they believe cost is unusally low
			+ Solution: results are not as robust when decomposing issuances
1. Data
	+ Compustat SSTK: pooled figure coming all forms of equity issuance that result in cash inflows
		+ YTD figure; need to subtract reported value in prior quarter
		+ subtract PSTKQ (preferred shares)
		+ Negative values set to zero; Missing set to zero
		+ Resulting number/quarter mkval $>$ 3\% then firm-initiated 
	+ Quaterly data; 1985-2011
	+ Exclude: financial firms; utilities; firms$<$ \$10m; Market/Book$>$ 15; negative BE
	+ 375133 firm-quarter observations; 12218 unique firms
	+ issuance proceeds normalized to 2011 CPI index
	+ scaled by market equity instead of total assets (what most other papers do)
	+ still some measurement error (options are still mixed in for instances identified as manager initiated) but are small amount
1. Size of Employee Initiated Issues in Aggregate
    + Total $1.1 trillion aggregate proceeds from employee-initiated issues
    + Since 2001, employee issuances account for more cash inflows than firm initiated issues
    + Kahle 2002: share repurchases are related to exercisable options; half of proceeds form ESO are returned to shareholders (findings hold for McKeon)
        + however, this depends on the size of the firm; smaller firms retain almost all of the proceeds
        + **market conditions are not most important determinant of repurchasing after ESO: firm size is major factor**
    + is decision to not repurchase (post ESO) same as manager decision to sell stock?
        + **undetermined by literature**; should gross proceeds be used or netted figures?
        + relevant to Kahle and Stulz (2012)
        + whether or not repurchases are netted out in empirical analysis, a substantial portion of resultant sample from pooled data and inference drawn from these samples should take into account potential impact of proceeds that are not firm-initiated
	
# Replication

```{r}
library(dplyr)
library(tidyr)
library(plotly)
library(lubridate)

raw_mckeon_ccm <- data.frame(read.csv("~/github_data/mckeon_ccm.csv")) # read in ccm data
raw_mckeon_crsp <- data.frame(read.csv("~/github_data/mckeon_crsp.csv")) # read in data
cpi <- data.frame(read.csv("~/github_data/cpi_2011.csv")) # read in cpi data

# format crsp data
mckeon_crsp<-raw_mckeon_crsp
mckeon_crsp$year <- year(parse_date_time(as.character(mckeon_crsp$date), "%Y%m%d"))
mckeon_crsp$qtr <- quarter(parse_date_time(as.character(mckeon_crsp$date), "%Y%m%d"))

mckeon_crsp <- raw_mckeon_crsp %>% 
    setNames(tolower(names(.))) %>% #lower case col names 
    filter(shrflg<12) %>% 
    mutate(year = year(parse_date_time(as.character(date), "%Y%m%d"))) %>% #create year
    mutate(qtr = quarter(parse_date_time(as.character(date), "%Y%m%d"))) %>% #create quarter
    mutate(mkval = ((shrout * cfacshr) * (abs(prc)/cfacpr))/1000) %>%  #create adjusted market value
    replace_na(list(mkval=0)) %>% 
    filter(mkval>.1) %>%
    group_by(permno, year, qtr) %>% summarize(mkval = last(mkval)) %>% 
    select(permno, year, qtr, mkval) # select only certain variables

mckeon_all <- raw_mckeon_ccm %>% 
    setNames(tolower(names(.))) %>% #lower case col names
    select(datadate, datacqtr, fyearq, fqtr, datacqtr, tic, conm, gvkey, lpermno, gsector, sstky, pstkq, pstkrq, mkvaltq, atq, ltq, sic, prccq, cshoq, prstkcy, prstkpcy) %>% # select only certain variables
    mutate(gsector = ordered(gsector,
        levels = c(seq(10,60,5)),
        labels = c("Energy", "Materials", "Industrials", "Consumer Disc.", "Consumer Staples", "Health Care", "Financials", "Info. Tech.", "Telecomm.", "Utilities", "Real Estate"))) %>% 
        filter(!(gsector %in% c("Financials","Utilities"))) %>% 
    mutate(year = year(parse_date_time(as.character(datadate), "%Y%m%d"))) %>% #create year
    mutate(qtr = quarter(parse_date_time(as.character(datadate), "%Y%m%d"))) %>% #create quarter
    full_join(., cpi, by = c("year" = "year")) %>% #merge in cpi data
    full_join(., mckeon_crsp, by = c("year" = "year","qtr" = "qtr" , "lpermno" = "permno")) %>%  # merge in crsp data
    replace_na(list(sstky = 0, atq = 0, ltq = 0)) %>% #remove nas from sstk
    mutate(cpi = cpi/100) %>% # scale cpi
    mutate(book = ifelse((atq - ltq)>0,atq-ltq,0)) %>% filter(book>.1) %>% # keep book value greater than zero
    mutate(mb = mkval/book) %>% # create market-book
    filter(year>=1985 & year<=2011) %>% # drop dates outside of 1985-2011
    filter(!(sic %in% c(4900:4949, 6000:6999))) %>% # drop financials and utilitie
    filter(atq>10) %>% # keep total assets greater than 10m; drops the most obs
    filter(mb<15) %>%  # keep market to book less than 15
    filter(sstky>0) %>% 
    mutate(decile = ntile(atq,10)) #but when to add such deciles??????

mckeon_sstk <- mckeon_all %>% 
    arrange(gvkey, year, qtr) %>% # YTD correction for SSTK
    # mutate(sstky = sstky/cpi) %>% # scale purchase amount by 
    group_by(lpermno, year) %>% 
    mutate(sstkq = ifelse(qtr>1, sstky - lag(sstky) - pstkq, sstky - pstkq)) %>% 
    # mutate(prstkcq = ifelse(qtr>1, prstkcy - lag(prstkcy) - prstkpcy, prstkcy - prstkpcy)) %>% 
    replace_na(list(sstkq = 0)) %>% 
    mutate(sstkq = ifelse(sstkq<0, 0, sstkq)) %>% 
    mutate(issue = sstkq/mkval) %>%  #create issue variable
    # filter(sstkq!=0) %>% # only keep where there was an issuance
    mutate(emp_init = ifelse(issue<.03, 1, 0)) %>% #flag employee issuance if less than 3%
    mutate(firm_init = ifelse(issue>=.03,1,0)) %>% #flag firm issuance if more than 3%
    mutate(emp_init_val = (sstkq*emp_init)/1000) %>% #create value for employee initiated
    mutate(firm_init_val = (sstkq*firm_init)/1000) %>% #create value for firm initiated
    filter(sstkq!=0)

```



```{r fig5_a}

mckeon_sstk %>% 
    group_by(year) %>%
    summarize(ei_n = sum(emp_init), firm_n = sum(firm_init)) %>% 
    plot_ly(., x=~year, y = ~ei_n, type="bar", name = "Employee Initiated") %>% 
        add_trace(y = ~firm_n, name = 'Firm Initiated') %>%
        layout(yaxis = list(title = 'Count'), barmode = 'group')

```


```{r fig5_b}

mckeon_sstk %>% 
    filter(year>2000) %>% 
    group_by(year) %>%
    summarize(ei_val = sum(emp_init_val), firm_val = sum(firm_init_val)) %>% 
    plot_ly(., x=~year, y = ~ei_val, type="bar", name = "Employee Initiated") %>% 
        add_trace(y = ~firm_val, name = 'Firm Initiated') %>%
        layout(yaxis = list(title = 'Count'), barmode = 'stack')


```

```{r fig6}

mckeon_sstk %>% 
    group_by(gsector) %>%
    summarize(ei_val = sum(emp_init_val)) %>% 
    plot_ly(., x=~gsector, y = ~ei_val, type="bar", name = "Employee Initiated") 

```

```{r tab5}

# looking for 220,695 obs

mckeon_tab5 <- mckeon_sstk %>% 
    group_by(year) %>% # by year
    summarise(proceeds_ei = round(sum(emp_init_val/cpi),1), proceeds_fi = round(sum(firm_init_val/cpi),1), n_ei = sum(emp_init), n_fi = sum(firm_init)) # get sums

# replicate table 5
mckeon_tab5["Total" ,] <- colSums(mckeon_tab5) # create total row
mckeon_tab5["Total","year"] <- ""
mckeon_tab5

```

```{r tab6}
mckeon_tab6 <- mckeon_sstk %>% 
    group_by(decile) %>% 
    summarize(med_ei = round(median(mkval),0), gross = round(sum(sstkq/100),0))

mckeon_tab6["Total" ,] <- colSums(mckeon_tab6) # create total row
mckeon_tab6["Total","decile"] <- ""

mckeon_tab6
    

```



